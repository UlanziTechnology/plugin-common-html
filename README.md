# ulanzideck-plugin-sdk-html

<p align="start">
   <strong>English</strong> | <a href="./README.zh.md">简体中文</a>
</p>

## Introduction
The ulanzideck-plugin-sdk encapsulates the WebSocket connection with the UlanziDeck and its related communication events. This simplifies the development process and enables developers to communicate with the UlanziDeck through simple event calls, allowing them to focus more on the development of plugin functions.


```bash
The current version is developed according to the Ulanzi JS Plugin Development Protocol - V1.2.2.
```


## File directory
```bash
libs   //This folder is the function of the plugin general library
├── css
│   └── udpi.css      //Common style, according to the convention format to write html, can take effect
├── js
│   ├── constants.js      //Event constants of the UlanziDeck
│   ├── eventEmitter.js   //Event Emitter
│   ├── timers.js         //Used to improve performance
│   ├── utils.js          //Some common methods of encapsulation, welcome to add, the current main functions: get the form of the action's html and the form of the form that overloads the action's html
│   └── ulanzideckApi.js    //This includes the encapsulation of all UlanziDeck events, websocket connection, and localized processing
├── assets
│   └── xxx.png          //CSS icon required, no need to change

```


## Instructions

### Some instructions and conventions

1. The main service of the plugin library (for example app.html) will always be connected to the UlanziDeck. Implement the main functions of the plugin, receive changes to action's params, update the status of icons, etc.

2. The action of the plugin library (for example inspector.html). The page will be destroyed after toggling the UlanziDeck button, so it is not appropriate to do functional processing. It is mainly used to send params to UlanziDeck and synchronize params from UlanziDeck.

3. For unified management, the name of our plugin package is com.ulanzi.pluginname.ulanziPlugin

4. For the normal use of the ulanzideck-plugin-sdk library, we agree that the uuid length of the main service connection is 4. Example: com.ulanzi.ulanzideck.pluginname

5. The uuid of the action connection must be greater than 4 for differentiation. Example: com.ulanzi.ulanzideck.pluginname.pluginaction

6. The localization file is placed in the plugin root directory, which is at the same level as the ulanzideck-plugin-sdk libs. (For the writing rules of localized json files, you can view the demo example) Example: zh_CN.json en.json ja_JP.json de_DE.json zh_HK.json

7. In order to unify UI fonts, we have set up the open source font Source Han Sans SC in udpi.css, and we also need to reference the font library in app.html. Please use 'Source Han Sans SC' uniformly when drawing icons。

8. The background color of UlanziDeck is '#282828', and the generic css (udpi.css) has been set to '--udpi-bgcolor: #282828; '。 If you want to customize the background color of the action, it should be the same as the background color of the UlanziDeck, so as to avoid the background color of the plug-in being too abrupt.


### How to use

```bash
For details on the usage and folder specifications of ulanzideck-plugin-sdk, see demo/com.ulanzi.analogclock.ulanziPlugin.
The following briefly describes how to use：
```

#### * context （A special parameter）

An action function may be configured on multiple keys, so the ulanzideck-plugin-sdk library concatenates a unique value <strong>context</strong>. When we create a feature instance, we only need to save the unique value <strong>context</strong>. If you need to update the data, you can send the message to the corresponding key value based on the corresponding unique value <strong>context</strong>.

```bash
1. The special parameter context, which is a unique value concatenated from the common library, is passed to the main service and action along with the received message。

2. The concatenation rule for context is uuid + '___' + key + '__' + actionid, generated by the corresponding $UD.encodeContext(msg).

3. We also provide $UD.decodeContext(context) to deconstruct unique values and return { uuid, key, actionid }.

4. Since the param of the clear event is in the form of an array, the context of clear is spliced ​​into the param. Please pay attention to loop acquisition when doing clear processing.

```

#### 1. Import files from the ulanzideck-plugin-sdk
```html
/**
 * The ulanzideckApi.js relies on eventEmitter.js and utils.js, which need to be referenced in the html page in the following order
*/

<script src="../../libs/js/constants.js"></script>
<script src="../../libs/js/eventEmitter.js"></script>
<script src="../../libs/js/timers.js"></script>
<script src="../../libs/js/utils.js"></script>
<script src="../../libs/js/ulanzideckApi.js"></script>

```

#### 2. How html adapts to udpi.css
```html
/**
 *Take the action html page as an example
*/


<!-- The action items need to be wrapped in form, and the items are associated with the name attribute. -->
<!-- After that, you can use Utils.getFormValue() to get the form data and Utils.setFormValue() to overload the form data. -->
<form id="property-inspector">   


  <!-- The label and value of the configuration item are wrapped with div.udpi-item, the label uses the udpi-item-label class name, and the value uses the udpi-item-value class name. -->
  <div class="udpi-item">
    
    <!-- data-localize. The first method indicates that localization is required. The writing page uses English by default, and the SDK translates it according to the content. Configure the corresponding json in the root directory, such as zh_CN.json -->
    <div class="udpi-item-label" data-localize>Name</div>
    <input type="text" class="udpi-item-value" name="name" value="test">
  </div>
  <div class="udpi-item">
    <div class="udpi-item-label" data-localize>Face</div>
    <select class="udpi-item-value select clockSelector" name="clock_index" >
      <!-- data-localize. In the second way, after data-localize assigns a value, the sdk will obtain the translation content based on the value. -->
      <option label="Blue" value="blue" data-localize="Blue"></option>
      <option label="Green" value="green" data-localize></option>
    </select>
  </div>
</form>

```

#### 3. Connect the UlanziDeck
Take the action's html page as an example to briefly demonstrate some methods. For details, please see[<a href="#title-4">4. Receive events(UlanziDeck->plugin)</a>][<a href="#title-5">5. Send Events(plugin->UlanziDeck)</a>]


```html

/**
 * $UD is an instance of the ulanzideckApi that connects to the UlanziDeck's websocket via $UD.connect(uuid).
 * 
*/

<script>
  //Connect to the websocket of the UlanziDeck. After successful connection, the event onConnected will be triggered
  $UD.connect('com.ulanzi.ulanzideck.analogclock.clock');
  $UD.onConnected(conn => {
    //Connected, dynamic nodes can be rendered here

  })


  //Drag to the button
  $UD.onAdd( message => {
    //Overloading of form can be implemented here.  Utils.setFormValue(message.param,form)
  })

  //Get initialization parameters
  $UD.onParamFromApp( message => {
      //Overloading of form can be implemented here.  Utils.setFormValue(message.param,form)
  })

  //Send parameters
  function sendData(params){
    $UD.sendParamFromPlugin(params)
  }

</script>

```

#### <span id="title-4" >4. Receive events(UlanziDeck->plugin)</span>
```js
/**
 * Listen for events from websocket connections and events from the UlanziDeck
*/
1. $UD.onConnected(conn => ())  //The websocket connection to the UlanziDeck is successful
2. $UD.onClose(conn => ())  //The websocket connection is closed
3. $UD.onError(conn => ())  //websocket connection error
4. $UD.onAdd(message => ())     //Receive event "cmd": "add" from UlanziDeck
5. $UD.onParamFromApp(message => ())  //Receive event "cmd": "paramfromapp" from UlanziDeck
6. $UD.onParamFromPlugin(message => ())  //Receive event "cmd": "paramfromplugin" from UlanziDeck
7. $UD.onRun(message => ())  //Receive event "cmd": "run" from UlanziDeck
8. $UD.onSetActive(message => ())  //Receive event "cmd": "setactive" from UlanziDeck
9. $UD.onClear(message => ())  //Receive event "cmd": "clear" from UlanziDeck
10. $UD.onSelectdialog(message => ())  //Receive event "cmd": "selectdialog" from UlanziDeck.Used to receive the results of selecting files/folders

```

#### <span id="title-5">5. Send Events(plugin->UlanziDeck)</span>

```js
/**
 * Send  parameters to the UlanziDeck
 * @param {object} settings Required | parameters
 * @param {object} context Optional | Unique value。It is not required to be passed. It does not need to be passed when it is sent from the action page. It must be passed when it is sent from the main service.
*/
1. $UD.sendParamFromPlugin(settings, context) 

/**
 * Set icon - use the icon list number in the configuration, please refer to manifest.json.
 * @param {string} context Required | Unique value, the  ulanzideck-plugin-sdk library in the received message will be automatically spliced ​​and given.
 * @param {number} state Required | Icon list number
 * @param {string} text Optional | Whether the icon displays text
*/
2. $UD.setStateIcon(context, state, text) 


  /**
 * Set icon - use custom icon
 * @param {string} context Required | Unique value, the  ulanzideck-plugin-sdk library in the received message will be automatically spliced ​​and given.
 * @param {string} data Required | icon in base64 format
 * @param {string} text Optional | Whether the icon displays text
*/
3. $UD.setBaseDataIcon(context, data, text) 


/**
 * Set icon-use local image file
 * @param {string} context Required | Unique value, the  ulanzideck-plugin-sdk library in the received message will be automatically spliced ​​and given.
 * @param {string} path  Required | Local image path, supports opening URL links under the plugin root directory (links starting with / ./)
 * @param {string} text Optional | Whether the icon displays text
*/
4. $UD.setPathIcon(context, path, text) 


/**
 * Set icon - use custom gif
 * @param {string} context Required | Unique value, the  ulanzideck-plugin-sdk library in the received message will be automatically spliced ​​and given.
 * @param {string} gifdata Required | Base64 encoded data of custom gif
 * @param {string} text Optional | Whether the icon displays text
*/
5. $UD.setGifDataIcon(context, gifdata, text) 



  /**
 * Set icon - use local gif file
 * @param {string} context Required | Unique value, the  ulanzideck-plugin-sdk library in the received message will be automatically spliced ​​and given.，
 * @param {string} gifdata  Required | Local gif image path, supports opening URL links under the plugin root directory (links starting with / ./)
 * @param {string} text Optional | Whether the icon displays text
*/
6. $UD.setGifPathIcon(context, gifpath, text) 


/**
 * A toast message pops up on the requesting UlanziDeck
 *  @param {string} msg Required | Window level message prompt
*/
7. $UD.toast(msg) 

/**
 * Request the UlanziDeck to pop up a selection dialog box: select file
 *  @param {string} filter Optional | File filter. Filter file type, such as "filter": "image(*.jpg *.png *.gif)" or filter file file(*.txt *.json) etc.
 * Please receive the selection result of this request through the onSelectdialog event
*/
8. $UD.selectFileDialog(filter) 


/**
 * Request the UlanziDeck to pop up a selection dialog box: select a folder
 * Please receive the selection result of this request through the onSelectdialog event
*/
9. $UD.selectFolderDialog() 


/**
 * Request the UlanziDeck to use the browser to open the url
 * @param {string} url Required | Supports remote paths and local paths, supports opening url links under the plug-in root directory (links starting with / ./)
 *                                It can only be the basic path and cannot take parameters. If you need to take parameters, please set them in the param value.
 * @param {local} boolean Optional | true if it is a local path
 * @param {object} param Optional | Parameter values of the path.
*/
10. $UD.openUrl(url, local, param)


/**
 * Request the UlanziDeck to display a pop-up window; After the pop-up window, test.html needs to actively close it, and test to window.close() to notify the pop-up window to close
 *  @param {string} url Required | Local HTML path. It can only be the basic path and cannot take parameters. If you need to take parameters, please set them in the param value.
 * @param {string} width Optional | Window width, default 200
 * @param {string} height Optional | Window height, default 200
 * @param {string} x Optional | The x coordinate of the window. If no value is passed, it will be centered by default.
 * @param {string} y Optional | The y coordinate of the window. If no value is passed, it will be centered by default.
 * @param {object} param Optional | Parameter values of the path.
*/
11. $UD.openView(url, width = 200, height = 200, x , y, param)




```